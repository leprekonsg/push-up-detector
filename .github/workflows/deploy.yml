name: Deploy STF Exercise Counter

on:
  push:
    branches: [ main ]

# Required permissions for GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Find and update HTML file
      run: |
        # Find the HTML file (could be index.html or another name)
        HTML_FILE=$(find . -maxdepth 1 -name "*.html" | head -1)
        
        if [ -z "$HTML_FILE" ]; then
          echo "‚ùå ERROR: No HTML file found in repository!"
          ls -la
          exit 1
        fi
        
        echo "Found HTML file: $HTML_FILE"
        
        # Replace placeholders with actual Firebase config (only in config object, not in conditions)
        sed -i 's/REPLACE_FIREBASE_API_KEY/${{ secrets.FIREBASE_API_KEY }}/g' "$HTML_FILE"
        sed -i 's/REPLACE_FIREBASE_AUTH_DOMAIN/${{ secrets.FIREBASE_AUTH_DOMAIN }}/g' "$HTML_FILE"
        sed -i 's/REPLACE_FIREBASE_PROJECT_ID/${{ secrets.FIREBASE_PROJECT_ID }}/g' "$HTML_FILE"
        sed -i 's/REPLACE_FIREBASE_STORAGE_BUCKET/${{ secrets.FIREBASE_STORAGE_BUCKET }}/g' "$HTML_FILE"
        sed -i 's/REPLACE_FIREBASE_MESSAGING_SENDER_ID/${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}/g' "$HTML_FILE"
        sed -i 's/REPLACE_FIREBASE_APP_ID/${{ secrets.FIREBASE_APP_ID }}/g' "$HTML_FILE"
        
        # Now restore the condition placeholder (since sed replaced ALL instances)
        sed -i 's/ !== "${{ secrets.FIREBASE_API_KEY }}"/ !== "REPLACE_FIREBASE_API_KEY"/g' "$HTML_FILE"
        
        # Rename to index.html if it's not already
        if [ "$HTML_FILE" != "./index.html" ]; then
          cp "$HTML_FILE" index.html
          echo "Copied $HTML_FILE to index.html"
        fi
    
    - name: Verify Firebase configuration was injected
      run: |
        echo "=== Files in directory ==="
        ls -la
        echo ""
        echo "=== Checking if Firebase config was properly injected ==="
        
        # Check if config object still has placeholders (bad)
        CONFIG_CHECK=$(grep -A 10 'window\.firebaseConfig = {' index.html | grep -c 'REPLACE_FIREBASE')
        # Check if condition has placeholder (good)
        CONDITION_CHECK=$(grep -c 'REPLACE_FIREBASE_API_KEY' index.html)
        
        echo "Config placeholders remaining: $CONFIG_CHECK"
        echo "Condition placeholders remaining: $CONDITION_CHECK"
        
        if [ "$CONFIG_CHECK" -gt 1 ]; then
          echo "‚ùå ERROR: Firebase placeholders were not replaced in config object!"
          echo "Please check if your GitHub Secrets are properly set."
          echo ""
          echo "Current secrets status:"
          echo "FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY != '' && 'SET' || 'NOT SET' }}"
          echo "FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN != '' && 'SET' || 'NOT SET' }}"
          echo "FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID != '' && 'SET' || 'NOT SET' }}"
          exit 1
        elif [ "$CONDITION_CHECK" -eq 1 ]; then
          echo "‚úÖ Firebase configuration successfully injected (condition preserved)"
        else
          echo "‚ö†Ô∏è Unexpected result - manual check needed"
        fi
        
        echo ""
        echo "=== Firebase config section in HTML ==="
        grep -A 12 -B 2 "window.firebaseConfig" index.html
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Deployment Success
      if: success()
      run: |
        echo "üöÄ Deployment successful!"
        echo "Your app is available at: ${{ steps.deployment.outputs.page_url }}"